#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: N8N
# N8N init script, runs before any other service
# ==============================================================================

bashio::log.info "Configuring N8N..."

# Ensure configuration data directory exists
if ! bashio::fs.directory_exists '/config/n8n/data'; then
    mkdir -p /config/n8n/data || bashio::exit.nok "Failed to create n8n configuration directory"
fi

if ! bashio::config 'ssl'; then
  protocol="http";
else
  protocol="https";
fi

bashio::var.json \
    protocol "$protocol" \
    public_url "$(bashio::config 'public_url' || '')" \
    host "$(bashio::addon.hostname)" \
    port "^$(bashio::addon.port 80)" \
    db_type "$(bashio::config 'db_type')" \
    db_name "$(bashio::config 'db_name')" \
    db_host "$(bashio::config 'db_host')" \
    db_port "^$(bashio::config 'db_port')" \
    db_user "$(bashio::config 'db_user')" \
    db_password "$(bashio::config 'db_password')" \
    log_level "$(bashio::string.lower "$(bashio::config 'log_level')")" \
    | tempio \
        -template /etc/n8n/config.gtpl \
        -out /config/n8n/config.json

if [ "$(bashio::config 'log_level')" == "debug" ]; then
  bashio::log.info "$(cat /config/n8n/config.json)"
fi

